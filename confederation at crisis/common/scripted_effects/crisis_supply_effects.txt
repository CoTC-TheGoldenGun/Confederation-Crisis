
fn_crisis_recalcsupply_in_province = {
#this function is called from different places, and as thus FROM and ROOT are NOT trustworthy.
#what is ensured, is that the "main scope" is a location scope that resolves to a province

    set_variable = { which = "supply_value" value = 0 }

    #castles
    any_province_holding = {
        limit = {
            has_building = ca_fleet_support_q_1
        }
        PREV = {
            change_variable = { which = "supply_value" value = 6 }
        }
    }

    any_province_holding = {
        limit = {
            has_building = ca_fleet_support_q_2
        }
        PREV = {
            change_variable = { which = "supply_value" value = 6 }
        }
    }

    any_province_holding = {
        limit = {
            has_building = ca_fleet_support_q_3
        }
        PREV = {
            change_variable = { which = "supply_value" value = 6 }
        }
    }

    any_province_holding = {
        limit = {
            has_building = ca_fleet_support_q_4
        }
        PREV = {
            change_variable = { which = "supply_value" value = 6 }
        }
    }

    any_province_holding = {
        limit = {
            has_building = ca_fleet_support_q_5
        }
        PREV = {
            change_variable = { which = "supply_value" value = 6 }
        }
    }

    any_province_holding = {
        limit = {
            has_building = ca_fleet_support_q_6
        }
        PREV = {
            change_variable = { which = "supply_value" value = 6 }
        }
    }

    any_province_holding = {
        limit = {
            has_building = ca_fleet_support_q_7
        }
        PREV = {
            change_variable = { which = "supply_value" value = 6 }
        }
    }

    any_province_holding = {
        limit = {
            has_building = ca_fleet_support_q_8
        }
        PREV = {
            change_variable = { which = "supply_value" value = 6 }
        }
    }

    #cities
    any_province_holding = {
        limit = {
            has_building = ct_agriculture_q_1
        }
        PREV = {
            change_variable = { which = "supply_value" value = 1 }
        }
    }
    any_province_holding = {
        limit = {
            has_building = ct_agriculture_q_2
        }
        PREV = {
            change_variable = { which = "supply_value" value = 1 }
        }
    }
    any_province_holding = {
        limit = {
            has_building = ct_agriculture_q_3
        }
        PREV = {
            change_variable = { which = "supply_value" value = 1 }
        }
    }
    any_province_holding = {
        limit = {
            has_building = ct_agriculture_q_4
        }
        PREV = {
            change_variable = { which = "supply_value" value = 1 }
        }
    }
    any_province_holding = {
        limit = {
            has_building = ct_agriculture_q_5
        }
        PREV = {
            change_variable = { which = "supply_value" value = 1 }
        }
    }
    any_province_holding = {
        limit = {
            has_building = ct_trade_center_q_1
        }
        PREV = {
            change_variable = { which = "supply_value" value = 1 }
        }
    }
    any_province_holding = {
        limit = {
            has_building = ct_trade_center_q_2
        }
        PREV = {
            change_variable = { which = "supply_value" value = 1 }
        }
    }
    any_province_holding = {
        limit = {
            has_building = ct_trade_center_q_3
        }
        PREV = {
            change_variable = { which = "supply_value" value = 1 }
        }
    }
    any_province_holding = {
        limit = {
            has_building = ct_trade_center_q_4
        }
        PREV = {
            change_variable = { which = "supply_value" value = 1 }
        }
    }
    any_province_holding = {
        limit = {
            has_building = ct_trade_center_q_5
        }
        PREV = {
            change_variable = { which = "supply_value" value = 1 }
        }
    }
    any_province_holding = {
        limit = {
            has_building = ct_factories_q_1
        }
        PREV = {
            change_variable = { which = "supply_value" value = 0.5 }
        }
    }
    any_province_holding = {
        limit = {
            has_building = ct_factories_q_2
        }
        PREV = {
            change_variable = { which = "supply_value" value = 0.5 }
        }
    }
    any_province_holding = {
        limit = {
            has_building = ct_factories_q_3
        }
        PREV = {
            change_variable = { which = "supply_value" value = 0.5 }
        }
    }
    any_province_holding = {
        limit = {
            has_building = ct_factories_q_4
        }
        PREV = {
            change_variable = { which = "supply_value" value = 0.5 }
        }
    }
    any_province_holding = {
        limit = {
            has_building = ct_factories_q_5
        }
        PREV = {
            change_variable = { which = "supply_value" value = 0.5 }
        }
    }
    any_province_holding = {
        limit = {
            has_building = ct_factories_q_6
        }
        PREV = {
            change_variable = { which = "supply_value" value = 0.5 }
        }
    }
    any_province_holding = {
        limit = {
            has_building = ct_factories_q_7
        }
        PREV = {
            change_variable = { which = "supply_value" value = 0.5 }
        }
    }
    any_province_holding = {
        limit = {
            has_building = ct_factories_q_8
        }
        PREV = {
            change_variable = { which = "supply_value" value = 0.5 }
        }
    }

    #temples
    any_province_holding = {
        limit = {
            has_building = tp_military_mathematics_q_1
        }
        PREV = {
            change_variable = { which = "supply_value" value = 1 }
        }
    }
    any_province_holding = {
        limit = {
            has_building = tp_military_mathematics_q_2
        }
        PREV = {
            change_variable = { which = "supply_value" value = 1 }
        }
    }
    any_province_holding = {
        limit = {
            has_building = tp_military_mathematics_q_3
        }
        PREV = {
            change_variable = { which = "supply_value" value = 1 }
        }
    }
    any_province_holding = {
        limit = {
            has_building = tp_military_mathematics_q_4
        }
        PREV = {
            change_variable = { which = "supply_value" value = 1 }
        }
    }
    any_province_holding = {
        limit = {
            has_building = tp_military_mathematics_q_5
        }
        PREV = {
            change_variable = { which = "supply_value" value = 1 }
        }
    }
    any_province_holding = {
        limit = {
            has_building = tp_military_mathematics_q_6
        }
        PREV = {
            change_variable = { which = "supply_value" value = 1 }
        }
    }

    remove_province_modifiers = {
        name = province_supply_from_building1
        amount = 10000
    }
    remove_province_modifiers = {
        name = province_supply_from_building2
        amount = 10000
    }
    remove_province_modifiers = {
        name = province_supply_from_building5
        amount = 10000
    }
    remove_province_modifiers = {
        name = province_supply_from_building10
        amount = 10000
    }
    remove_province_modifiers = {
        name = province_supply_from_building20
        amount = 10000
    }
    remove_province_modifiers = {
        name = province_supply_from_building50
        amount = 10000
    }

    while = {
        limit = {
            check_variable = {
                which = "supply_value"
                value >= 50
            }
        }
        subtract_variable = {
            which = "supply_value"
            value = 50
        }
        add_province_modifier = {
            name = province_supply_from_building50
            duration = -1
            stacking = yes
        }
    }
    while = {
        limit = {
            check_variable = {
                which = "supply_value"
                value >= 20
            }
        }
        subtract_variable = {
            which = "supply_value"
            value = 20
        }
        add_province_modifier = {
            name = province_supply_from_building20
            duration = -1
            stacking = yes
        }
    }
    while = {
        limit = {
            check_variable = {
                which = "supply_value"
                value >= 10
            }
        }
        subtract_variable = {
            which = "supply_value"
            value = 10
        }
        add_province_modifier = {
            name = province_supply_from_building10
            duration = -1
            stacking = yes
        }
    }
    while = {
        limit = {
            check_variable = {
                which = "supply_value"
                value >= 5
            }
        }
        subtract_variable = {
            which = "supply_value"
            value = 5
        }
        add_province_modifier = {
            name = province_supply_from_building5
            duration = -1
            stacking = yes
        }
    }
    while = {
        limit = {
            check_variable = {
                which = "supply_value"
                value >= 2
            }
        }
        subtract_variable = {
            which = "supply_value"
            value = 2
        }
        add_province_modifier = {
            name = province_supply_from_building2
            duration = -1
            stacking = yes
        }
    }
    while = {
        limit = {
            check_variable = {
                which = "supply_value"
                value > 0
            }
        }
        subtract_variable = {
            which = "supply_value"
            value = 1
        }
        add_province_modifier = {
            name = province_supply_from_building1
            duration = -1
            stacking = yes
        }
    }
}
